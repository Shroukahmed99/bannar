// ad_manager.dart
import 'package:google_mobile_ads/google_mobile_ads.dart';

class AdManager {
  // Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
  static const String _realBannerAdUnitId = 'ca-app-pub-7376650992574816/4176453695';
  static const String _realInterstitialAdUnitId = 'ca-app-pub-7376650992574816/9536886738';
  
  // Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±)
  static const String _testBannerAdUnitId = 'ca-app-pub-3940256099942544/6300978111';
  static const String _testInterstitialAdUnitId = 'ca-app-pub-3940256099942544/1033173712';
  
  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±
  static bool _isTestMode = true;
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
  static String get bannerAdUnitId => _isTestMode ? _testBannerAdUnitId : _realBannerAdUnitId;
  static String get interstitialAdUnitId => _isTestMode ? _testInterstitialAdUnitId : _realInterstitialAdUnitId;
  
  // Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
  BannerAd? _bannerAd;
  InterstitialAd? _interstitialAd;
  bool _isBannerAdLoaded = false;
  bool _isInterstitialAdReady = false;
  
  // Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠÙ†ÙŠØ©
  DateTime? _lastInterstitialShownTime;
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø±
  bool get isBannerAdLoaded => _isBannerAdLoaded;
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø±
  BannerAd? get bannerAd => _bannerAd;
  
  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
  void initialize() {
    print("ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª... ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: $_isTestMode");
    MobileAds.instance.updateRequestConfiguration(
      RequestConfiguration(
        testDeviceIds: ["7C38AD7B7B7B7B7B7B7B7B7B7B7B7B7B"], // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù…Ø¹Ø±Ù Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
      ),
    );
    
    loadBannerAd();
    loadInterstitialAd();
  }
  
  // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø± Ù…Ø¹ Ø¢Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
  void loadBannerAd() {
    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù† Ø³Ø§Ø¨Ù‚ ÙˆØ¥Ø²Ø§Ù„ØªÙ‡
    if (_bannerAd != null) {
      _bannerAd!.dispose();
      _bannerAd = null;
    }
    
    print("ğŸ“¢ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø±... Ù…Ø¹Ø±Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†: ${bannerAdUnitId}");
    
    _bannerAd = BannerAd(
      adUnitId: bannerAdUnitId, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ØµØ­ÙŠØ­
      size: AdSize.banner,
      request: AdRequest(),
      listener: BannerAdListener(
        onAdLoaded: (ad) {
          print("âœ… Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø± ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­!");
          _isBannerAdLoaded = true; // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        },
        onAdFailedToLoad: (ad, error) {
          print("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø±: ${error.message}");
          _isBannerAdLoaded = false;
          ad.dispose();
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
          print("â±ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨Ø§Ù†Ø± Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©...");
          Future.delayed(Duration(seconds: 30), loadBannerAd);
        },
      ),
    );

    _bannerAd!.load();
  }
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ Ù…Ø¹ Ø¢Ù„ÙŠØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
  void loadInterstitialAd() {
    print("ğŸ“¢ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ... Ù…Ø¹Ø±Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†: ${interstitialAdUnitId}");
    
    if (_interstitialAd != null) {
      _interstitialAd!.dispose();
      _interstitialAd = null;
    }
    
    InterstitialAd.load(
      adUnitId: interstitialAdUnitId,
      request: AdRequest(),
      adLoadCallback: InterstitialAdLoadCallback(
        onAdLoaded: (InterstitialAd ad) {
          print("âœ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­!");
          _interstitialAd = ad;
          _isInterstitialAdReady = true;
          
          _interstitialAd!.fullScreenContentCallback = FullScreenContentCallback(
            onAdDismissedFullScreenContent: (InterstitialAd ad) {
              print("ğŸ”„ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
              _isInterstitialAdReady = false;
              ad.dispose();
              _interstitialAd = null;
              _lastInterstitialShownTime = DateTime.now();
              loadInterstitialAd();
            },
            onAdFailedToShowFullScreenContent: (InterstitialAd ad, AdError error) {
              print("âŒ ÙØ´Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ: $error");
              _isInterstitialAdReady = false;
              ad.dispose();
              _interstitialAd = null;
              loadInterstitialAd();
            },
          );
        },
        onAdFailedToLoad: (LoadAdError error) {
          print("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ: $error");
          _interstitialAd = null;
          _isInterstitialAdReady = false;
          
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø©
          if (error.code == 3) { // Ø±Ù…Ø² Ø§Ù„Ø®Ø·Ø£ "No fill"
            print("â±ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©...");
            Future.delayed(Duration(seconds: 30), loadInterstitialAd);
          } else {
            print("â±ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 60 Ø«Ø§Ù†ÙŠØ©...");
            Future.delayed(Duration(minutes: 1), loadInterstitialAd);
          }
        },
      ),
    );
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
  Future<bool> showInterstitialAd() async {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ
    if (_interstitialAd == null || !_isInterstitialAdReady) {
      print("âš ï¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯.");
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± Ù…ØªÙˆÙØ±
      loadInterstitialAd();
      return false;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ù…Ù†Ø° Ø¢Ø®Ø± Ø¹Ø±Ø¶
    if (_lastInterstitialShownTime != null) {
      final difference = DateTime.now().difference(_lastInterstitialShownTime!);
      if (difference.inSeconds < 60) { // Ù…Ù†Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø© ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
        print("â±ï¸ Ù„Ù… ÙŠÙ…Ø± ÙˆÙ‚Øª ÙƒØ§ÙÙ Ù…Ù†Ø° Ø¢Ø®Ø± Ø¹Ø±Ø¶ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ (${difference.inSeconds} Ø«Ø§Ù†ÙŠØ©).");
        return false;
      }
    }

    try {
      await Future.delayed(Duration(seconds: 1)); // ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¶
      print("ğŸ¯ Ø¬Ø§Ø±ÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ...");
      
      // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ø³Ø®Ø© Ù…Ø¤Ù‚ØªØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
      final InterstitialAd adToShow = _interstitialAd!;
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
      _interstitialAd = null;
      _isInterstitialAdReady = false;
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
      adToShow.show();
      
      // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¹Ø±Ø¶
      _lastInterstitialShownTime = DateTime.now();
      
      // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯
      loadInterstitialAd();
      
      return true;
    } catch (e) {
      print("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ: $e");
      _isInterstitialAdReady = false;
      loadInterstitialAd();
      return false;
    }
  }
  
  // ØªÙˆÙ‚ÙŠÙ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
  void dispose() {
    _bannerAd?.dispose();
    _interstitialAd?.dispose();
    _bannerAd = null;
    _interstitialAd = null;
  }
  
  // Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
  static void setTestMode(bool isTestMode) {
    _isTestMode = isTestMode;
    print("ğŸ”§ ØªÙ… Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: $_isTestMode");
  }
}